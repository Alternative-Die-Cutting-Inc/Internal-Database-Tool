/* ShopRates is a controller. It runs this function to load the stuff within
the scope of ng-controller=ShopRates on index.php */function ShopRates(e,t){t.post("php/QT_helper.php",{data:{request:"get_table_row",table:"QT_MasterRates"}}).success(function(t,n){e.status=n;e.data=t;e.rates=t}).error(function(t,n){console.log("Post failed.");e.data=t||"Request failed";e.status=n});t.post("php/QT_helper.php",{data:{request:"get_table",table:"QT_Press"}}).success(function(t,n){e.status=n;e.data=t;e.press_rates=t}).error(function(t,n){console.log("Post failed.");e.data=t||"Request failed";e.status=n});t.post("php/QT_helper.php",{data:{request:"get_table",table:"QT_Gluer"}}).success(function(t,n){e.status=n;e.data=t;e.gluer_rates=t}).error(function(t,n){console.log("Post failed.");e.data=t||"Request failed";e.status=n})}function QuoteController(e,t){e.quoteNumber;e.quoteQuantities={};e.presses=[];e.quantityRates={};e.stocks={};e.gluers=[];e.quoteCreated=!1;e.quantityExtras={};e.partition={};e.customers=["ActionScript","AppleScript","Asp","BASIC","C","C++","Clojure","COBOL","ColdFusion","Erlang","Fortran","Groovy","Haskell","Java","JavaScript","Lisp","Perl","PHP","Python","Ruby","Scala","Scheme"];e.emaillist=["sadf"];e.getQuantityRates=function(){$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"get_rates",quote_number:e.quoteNumber},success:function(t,n){e.quantityRates=t;console.log(t)}})};if(existingQuote==null){e.author=author;$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"get_max_quote"},success:function(t,n){e.quoteNumber=t+1}})}else{e.quoteNumber=existingQuote;e.quoteCreated=!0;t.post("php/QT_helper.php",{data:{request:"get_quantities",quote_number:e.quoteNumber}}).success(function(t,n){if(!t.ERROR){e.quoteQuantities=t;var r=-1;for(var i=1;i<=Object.keys(e.quoteQuantities).length;i++){if(i%3===1){r++;e.partition[r]=[]}e.partition[r].push(e.quoteQuantities[i])}}else console.log(t)}).error(function(e,t){console.log("Post failed.")});t.post("php/QT_helper.php",{data:{request:"get_extras",quote_number:e.quoteNumber}}).success(function(t,n){t.ERROR||(e.quantityExtras=t)}).error(function(e,t){console.log("Post failed.")});t.post("php/QT_helper.php",{data:{request:"get_quote",quote_number:e.quoteNumber}}).success(function(t,n){if(!t.ERROR){var r=["customer","job_name","attention","description","notes","date","author"];for(var i=0;i<r.length;i++){field=r[i];e[field]=t[field]!=="NULL"?t[field]:""}}else console.log(t);e.getCustomerEmails()}).error(function(e,t){console.log("Post failed.")});e.getQuantityRates();e.getCustomerEmails=function(){t.post("php/QT_helper.php",{data:{request:"get_customer_emails",customer:e.customer}}).success(function(t,n){t.ERROR?console.log(t):e.emaillist=t}).error(function(e,t){console.log("Post failed.")})}}e.createQuote=function(){$("#infoModal").foundation("reveal","close");if(!e.quoteCreated)$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"create_quote",quote_number:e.quoteNumber,customer:e.customer,job_name:e.job_name,description:e.description,notes:e.notes,author:e.author,attention:e.attention},success:function(t,n){if(!t.ERROR){e.quoteCreated=!0;e.date=t.Date;e.getQuantityRates()}else console.log(t)},error:function(e,t){console.log(e.responseText)}});else{var t=["customer","job_name","attention","description","notes","date","author"];for(var n=0;n<t.length;n++){field=t[n];e.saveQuoteData(field,e[field])}}};$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"get_table_visible",table:"QT_Press"},success:function(t,n){for(var r in t)e.presses.push(t[r])}});$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"get_table_visible",table:"QT_Gluer"},success:function(t,n){for(var r in t)e.gluers.push(t[r])}});$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"get_table_visible",table:"QT_Stock"},success:function(t,n){e.stocks=t}});$.ajax({asych:!1,url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"get_customers"},success:function(t,n){e.customers=t},error:function(e,t){}});e.createQuantity=function(){e.quoteCreated&&$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"create_quantity",quote_number:e.quoteNumber,customer:e.customer},success:function(t,n){e.quoteQuantities[t.quantity_id]=t;e.$apply();e.getQuantityRates();$(document).foundation("forms");console.log(t)},error:function(e,t){console.log(e.responseText)}})};e.pressChange=function(t){var n=this.selectedPress;QT.updateQuoteQuantityValue(e.quoteNumber,t,"press_id",n);e.quoteQuantities[t].press_id=n;var r=$.grep(e.presses,function(e){return e.press_id==n})[0].rate;e.quantityRates[t].press_per_hour=r;QT.updateQuantityRateValue(e.quoteNumber,t,"press_per_hour",r);var s=["die","cutter","press_setup"];for(i in s)e.recalculateTotal(t,s[i]);e.recalculateTotalWithPerM(t,"press");e.calculateTotal(t)};e.gluerChange=function(t){var n=this.selectedGluer;QT.updateQuoteQuantityValue(e.quoteNumber,t,"gluer_id",n);e.quoteQuantities[t].gluer_id=n;var r=$.grep(e.gluers,function(e){return e.gluer_id==n})[0].rate;e.quantityRates[t].gluer_per_hour=r;QT.updateQuantityRateValue(e.quoteNumber,t,"gluer_per_hour",r);e.recalculateTotal(t,"gluer_setup");e.recalculateTotalWithPerM(t,"gluer");e.calculateTotal(t)};e.stockChange=function(t){var n=this.selectedStock;QT.updateQuoteQuantityValue(e.quoteNumber,t,"stock_id",n);e.calculateTotal(t)};e.calculateTotal=function(t){var n=[],r=["die_total","cutter_total","press_setup_total","press_runspeed_total","gluer_setup_total","gluer_runspeed_total","strip_runspeed_total","handwork_runspeed_total","fold_total","package_total","pickup_skids_total","delivery_skids_total"],s=0;for(i in r){var o=e.quoteQuantities[t][r[i]];isNaN(o)||(s+=parseFloat(o))}for(var u in e.quantityExtras[t])s+=parseFloat(e.quantityExtras[t][u].cost);s=QT.inDollars(s);n.push({col:"subtotal",val:s});var a=e.quantityRates[t].customer_premium,f=e.quantityRates[t].global_premium,l=QT.inDollars(s*a*f);n.push({col:"total",val:l});var c=l-s;n.push({col:"premium",val:c});var h=e.quoteQuantities[t].units;if(h==0)var p=0;else var p=QT.inDollars(l/(h/1e3));n.push({col:"total_per_m",val:p});e.saveValues(n,t)};e.saveValues=function(t,n){for(var r=0;r<t.length;r++){e.quoteQuantities[n][t[r].col]=t[r].val;QT.updateQuoteQuantityValue(e.quoteNumber,n,t[r].col,t[r].val)}};e.recalculateTotalWithPerM=function(t,n){var r,i;switch(n){case"press":i=e.quoteQuantities[t].sheets;r=e.quantityRates[t][n+"_per_hour"];break;case"fold":default:r=e.quantityRates[t][n+"_per_hour"];i=e.quoteQuantities[t].units}if(r!=null){var s=e.quoteQuantities[t][n+"_runspeed"];if(i==0|s==0)var o=0,u=0;else var o=QT.inDollars(r*100*(i/s)/100),u=QT.inDollars(o*100/(i/1e3)/100);e.saveValues([{col:n+"_per_m",val:u},{col:n+"_runspeed_total",val:o}],t)}};e.recalculateTotal=function(t,n){var r=e.quoteQuantities[t][n],i=n+"_total";switch(n){case"package_per_m_units":var s=e.quoteQuantities[t].units/1e3,i="package_total";break;case"fold_per_m_units":var s=e.quoteQuantities[t].units/1e3,i="fold_total";break;case"die":case"cutter":case"press_setup":var s=e.quantityRates[t].press_per_hour;break;case"gluer_setup":var s=e.quantityRates[t].gluer_per_hour;break;default:}if(s!=null){var o=QT.inDollars(s*r);e.saveValues([{col:i,val:o}],t)}};e.recalculateShipmentTotal=function(t,n){var r=e.quoteQuantities[t][n],i=n+"_total";switch(n){case"delivery_skids":var s=e.quantityRates[t].delivery_first_skid,o=e.quantityRates[t].delivery_per_skid;break;case"pickup_skids":var s=e.quantityRates[t].pickup_first_skid,o=e.quantityRates[t].pickup_per_skid;break;default:}if(r==0)var u=0;else var u=QT.inDollars(parseFloat(s)+o*(r-1));e.saveValues([{col:i,val:u}],t)};e.recalculateRate=function(t,n){var r=parseFloat(e.quoteQuantities[t].sheets),i=parseFloat(e.quoteQuantities[t][n+"_per_m"]),s=parseFloat(e.quoteQuantities[t][n+"_runspeed"]),o=n+"_runspeed_total",u=parseFloat(e.quantityRates[t][n+"_per_hour"]),a=n+"_per_hour";if(r>0){var f=QT.inDollars(i*s*100/1e3/100);if(f>0){e.quantityRates[t][a]=f;QT.updateQuantityRateValue(e.quoteNumber,t,a,f)}}};e.recalculateSheets=function(t){var n=["press","gluer","strip","handwork"];for(i in n)e.recalculateTotalWithPerM(t,n[i]);e.recalculateTotal(t,"package_per_m_units");e.recalculateTotal(t,"fold_per_m_units")};e.safeApply=function(e){var t=this.$root.$$phase;t=="$apply"||t=="$digest"?e&&typeof e=="function"&&e():this.$apply(e)};e.addExtra=function(n){t.post("php/QT_helper.php",{data:{request:"add_extra",quote_number:e.quoteNumber,quantity_id:n}}).success(function(t,r){e.quantityExtras[n]===undefined&&(e.quantityExtras[n]={});e.quantityExtras[n][t.result.extra_id]=t.result;console.log(e.quantityExtras)}).error(function(e,t){console.log("Post failed.")})};e.setExtraField=function(n,r,i){t.post("php/QT_helper.php",{data:{request:"set_extra_field",quote_number:e.quoteNumber,quantity_id:n,extra_id:r,column:i,val:e.quantityExtras[n][r][i]}}).success(function(e,t){e.ERROR&&console.log(e)}).error(function(e,t){console.log("Post failed.")})};e.deleteExtra=function(n,r){console.log("Removing extra id: "+n);t.post("php/QT_helper.php",{data:{request:"delete_extra_field",quote_number:e.quoteNumber,quantity_id:r,extra_id:n}}).success(function(t,i){t.ERROR?console.log(t):delete e.quantityExtras[r][n]}).error(function(e,t){console.log("Post failed.")})};e.deleteQuantity=function(n){console.log("Removing quantity: "+n);t.post("php/QT_helper.php",{data:{request:"delete_quantity",quote_number:e.quoteNumber,quantity_id:n}}).success(function(t,r){t.ERROR?console.log(t):delete e.quoteQuantities[n]}).error(function(e,t){console.log("Post failed.")})};e.saveQuoteData=function(n,r){t.post("php/QT_helper.php",{data:{request:"save_quote_data",quote_number:e.quoteNumber,column:n,value:r}}).success(function(e,t){e.ERROR&&console.log(e)}).error(function(e,t){console.log("Post failed.")})};e.setAll=function(t){var n=e.quoteQuantities[t],r=[];for(var i in n)i!=="quantity_id"&&i!=="units"&&i!=="units_per_sheet"&&i!=="sheets"&&i!=="$$hashKey"&&r.push({col:i,val:n[i]});for(var s in e.quoteQuantities)e.saveValues(r,s);for(var s in e.quoteQuantities){e.quantityExtras[s]===undefined&&(e.quantityExtras[s]={});for(var o in e.quantityExtras[t]){extraColumns=["cost","cost_per_m","extra_id","name"];for(var u in extraColumns){var i=extraColumns[u];e.quantityExtras[s][o]===undefined&&(e.quantityExtras[s][o]={});e.quantityExtras[s][o][i]=e.quantityExtras[t][o][i];e.setExtraField(s,o,i)}e.quantityExtras[s][o].quantity_id=s;e.setExtraField(s,o,"quantity_id")}e.recalculateOnSetAll(s)}};e.setChecked=function(t){var n=e.quoteQuantities[t],r=[];for(var i in n)i!=="quantity_id"&&i!=="units"&&i!=="units_per_sheet"&&i!=="sheets"&&r.push({col:i,val:n[i]});for(var s in e.checked)e.checked[s].checked&&e.saveValues(r,s);for(var s in e.checked)if(e.checked[s].checked){e.checked[s].checked=!1;e.quantityExtras[s]===undefined&&(e.quantityExtras[s]={});for(var o in e.quantityExtras[t]){extraColumns=["cost","cost_per_m","extra_id","name"];for(var u in extraColumns){var i=extraColumns[u];e.quantityExtras[s][o]===undefined&&(e.quantityExtras[s][o]={});e.quantityExtras[s][o][i]=e.quantityExtras[t][o][i];e.setExtraField(s,o,i)}e.quantityExtras[s][o].quantity_id=s;e.setExtraField(s,o,"quantity_id")}e.recalculateOnSetAll(s)}};e.check=function(t){e.checked[t]===undefined&&(e.checked[t]={checked:!1});e.checked[t].checked=!e.checked[t].checked;console.log(e.checked)};e.checked={};e.recalculateOnSetAll=function(t){e.recalculateTotal(t,"package_per_m_units");var n=["press","gluer","strip","handwork"];for(var r in n)e.recalculateTotalWithPerM(t,n[r]);var i=e.quoteQuantities[t].units;for(var s in e.quantityExtras[t]){var o=e.quantityExtras[t][s].cost_per_m;e.quantityExtras[t][s].cost=QT.inDollars(100*o*(i/1e3)/100);e.setExtraField(t,s,"cost")}e.calculateTotal(t)};e.loader="";e.emailClientPDF=function(){e.loader="loader yellow";t.post("php/clientsheet_pdf_helper.php",{data:{request:"email_client_pdf",quote_number:e.quoteNumber,customer:e.customer,input_emails:e.inputEmails,client_email:e.clientEmail,message:e.message}}).success(function(t,n){t.ERROR?e.notice=t.ERROR:e.notice=t.SUCCESS;console.log(t);e.loader=""}).error(function(e,t){console.log("Post failed.")})}}function range(e,t,n){if(typeof t=="undefined"){t=e;e=0}typeof n=="undefined"&&(n=1);var r=[];for(var i=e;n>0?i<t:i>t;i+=n)r.push(i);return r}function cloneObject(e){if(e===null||typeof e!="object")return e;var t=e.constructor();for(var n in e)t[n]=cloneObject(e[n]);return t}QT={};QT.init=function(e){if(existingQuote==null){$("#infoModal").foundation("reveal","open");$("#customers").focus()}};QT.cache=function(){QT.dom={};QT.constants={}};$(document).ready(function(e){$(document).foundation();QT.init(e)});QT.setMasterRate=function(e,t,n,r){r.post("php/QT_helper.php",{data:{request:"set_master_rate",rate:e,name:t,table:n}}).success(function(e,t){console.log(e)}).error(function(e,t){console.log("Post failed.")})};QT.updateQuoteQuantityValue=function(e,t,n,r){if(isNaN(r)&&n!=="private_notes"&&n!=="public_notes"){console.log("Attempted to update "+e+"."+t+"."+n+" with "+r);return}$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"update_quote_quantity",quote_number:e,quantity_id:t,column:n,value:r},success:function(e,t){e.ERROR&&console.log(e.ERROR)},error:function(e,t){}})};QT.updateQuantityRateValue=function(e,t,n,r){isNaN(r)&&console.log("Attempted to update "+e+"."+t+"."+n+" with "+r);$.ajax({url:"php/QT_helper.php",type:"POST",dataType:"json",data:{request:"update_quantity_rate",quote_number:e,quantity_id:t,column:n,value:r},success:function(e,t){console.log(e)},error:function(e,t){}})};QT.inDollars=function(e){return Math.floor(e*100)/100};